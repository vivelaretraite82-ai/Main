<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Messagerie — Vive la Retraite</title>
  <style>
    :root {
      --bg: #0E1111;
      --card: #121616;
      --text: #F3F3F0;
      --text-light: #C6C6C0;
      --gold: #D5BA7B;
      --border: rgba(255,255,255,0.08);
      --accent: #7ec8a2;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      line-height: 1.5;
    }
    header {
      position: sticky;
      top: 0;
      background: rgba(14,17,17,0.8);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
      padding: .75rem 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .brand { font-weight: 700; letter-spacing: .3px; }
    .brand em { color: var(--gold); font-style: normal; }
    .back-link { color: var(--text-light); text-decoration: none; }
    .container { max-width: 1100px; margin: 1rem auto; padding: 0 1rem; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; }
    .split {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 1rem;
      min-height: calc(100vh - 110px);
    }
    .threads {
      padding: .75rem;
      overflow-y: auto;
      border-right: 1px solid var(--border);
    }
    .thread {
      padding: .6rem .5rem;
      border-radius: 10px;
      cursor: pointer;
      border: 1px solid transparent;
    }
    .thread:hover { background: rgba(255,255,255,0.04); }
    .thread.active { background: rgba(255,255,255,0.06); border-color: var(--border); }
    .thread-title { font-size: .95rem; }
    .thread-meta { font-size: .75rem; color: var(--text-light); }
    .chat {
      display: grid;
      grid-template-rows: auto 1fr auto;
      height: calc(100vh - 140px);
    }
    .chat-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
    }
    .chat-list {
      padding: 1rem;
      overflow-y: auto;
    }
    .msg { margin-bottom: .7rem; display: flex; }
    .msg.me { justify-content: flex-end; }
    .bubble {
      max-width: 76%;
      padding: .55rem .75rem;
      border-radius: 14px;
      font-size: .92rem;
      line-height: 1.4;
    }
    .msg.me .bubble { background: var(--gold); color: #111; }
    .msg.them .bubble { background: rgba(255,255,255,0.08); color: var(--text); }
    .meta { font-size: .72rem; color: var(--text-light); margin-top: .15rem; }
    .composer {
      border-top: 1px solid var(--border);
      padding: .6rem;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: .6rem;
    }
    textarea {
      width: 100%;
      min-height: 54px;
      max-height: 180px;
      resize: vertical;
      border-radius: 12px;
      background: #0d1010;
      border: 1px solid var(--border);
      color: var(--text);
      padding: .7rem .8rem;
      outline: none;
    }
    button.btn {
      background: var(--accent);
      color: #0b2819;
      border: none;
      padding: .75rem 1rem;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
    }
    .gate {
      max-width: 520px;
      margin: 2rem auto;
      padding: 1rem;
    }
    .gate h2 { margin-top: 0; }
    .form-group { margin-bottom: .9rem; }
    .label { display: block; font-size: .9rem; margin-bottom: .3rem; color: var(--text-light); }
    .input {
      width: 100%;
      padding: .7rem .8rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #0d1010;
      color: var(--text);
    }
    .note { font-size: .85rem; color: var(--text-light); margin-top: .35rem; }
  </style>
</head>
<body>
  <header>
    <a class="back-link" href="index.html">← Retour à l’accueil</a>
    <div class="brand">Vive la <em>Retraite</em> — Messagerie</div>
  </header>

  <div class="container" id="app"></div>

  <script>
    const API_BASE = '';
    const ADMIN_EMAIL = 'vivelaretraite82@gmail.com';
    let authToken = window.localStorage.getItem('vivelaretraite-token') || '';
    let currentUser = null;
    let adminActiveUserId = null;

    function h(html) { const t = document.createElement('template'); t.innerHTML = html.trim(); return t.content.firstChild; }
    function dateStr(s) { return s ? String(s).replace('T',' ').slice(0,16) : ''; }
    function isAdminEmail(e) { return String(e || '').trim().toLowerCase() === ADMIN_EMAIL; }

    function renderGate() {
      const app = document.getElementById('app');
      app.innerHTML = '';
      app.appendChild(h(`
        <div class="card gate">
          <h2>Se connecter pour accéder à la messagerie</h2>
          <div class="form-group">
            <label class="label">Email</label>
            <input class="input" type="email" id="gate-email" placeholder="ex: jean.dupont@email.com">
          </div>
          <div class="form-group">
            <label class="label">Mot de passe</label>
            <input class="input" type="password" id="gate-pass" placeholder="Votre mot de passe">
          </div>
          <button class="btn" id="gate-login">Se connecter</button>
          <div class="note" id="gate-note"></div>
        </div>
      `));
      document.getElementById('gate-login').addEventListener('click', () => {
        const email = String(document.getElementById('gate-email').value || '').trim();
        const password = String(document.getElementById('gate-pass').value || '');
        const note = document.getElementById('gate-note');
        note.textContent = '';
        if (!email || !password) { note.textContent = 'Merci d’indiquer votre email et mot de passe.'; return; }
        fetch(API_BASE + '/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        })
          .then(r => r.json().then(data => ({ ok: r.ok, data })))
          .then(({ ok, data }) => {
            if (!ok) { note.textContent = 'Identifiants incorrects.'; return; }
            authToken = data.token;
            window.localStorage.setItem('vivelaretraite-token', authToken);
            currentUser = data.user;
            boot();
          })
          .catch(() => { note.textContent = 'Erreur réseau. Réessayez.'; });
      });
    }

    function renderMemberChat() {
      const app = document.getElementById('app');
      app.innerHTML = '';
      app.appendChild(h(`
        <div class="card chat">
          <div class="chat-header">Conversation avec Alexandra</div>
          <div class="chat-list" id="chat-list"></div>
          <div class="composer">
            <textarea id="chat-text" placeholder="Écrire un message…"></textarea>
            <button class="btn" id="chat-send">Envoyer</button>
          </div>
        </div>
      `));
      document.getElementById('chat-send').addEventListener('click', () => {
        const text = String(document.getElementById('chat-text').value || '').trim();
        if (!text) return;
        fetch(API_BASE + '/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + authToken },
          body: JSON.stringify({ body: text })
        }).then(r => r.ok ? r.json() : Promise.reject())
          .then(() => { document.getElementById('chat-text').value = ''; loadMemberMessages(); })
          .catch(() => {});
      });
      loadMemberMessages();
      setInterval(loadMemberMessages, 5000);
    }

    function renderAdminChat() {
      const app = document.getElementById('app');
      app.innerHTML = '';
      app.appendChild(h(`
        <div class="card split">
          <div class="threads" id="threads"></div>
          <div class="chat">
            <div class="chat-header" id="admin-chat-header">Sélectionner une conversation</div>
            <div class="chat-list" id="admin-chat-list"></div>
            <div class="composer">
              <textarea id="admin-chat-text" placeholder="Votre réponse…"></textarea>
              <button class="btn" id="admin-chat-send">Envoyer</button>
            </div>
          </div>
        </div>
      `));
      document.getElementById('admin-chat-send').addEventListener('click', () => {
        const text = String(document.getElementById('admin-chat-text').value || '').trim();
        if (!text || !adminActiveUserId) return;
        fetch(API_BASE + '/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + authToken },
          body: JSON.stringify({ body: text, user_id: adminActiveUserId })
        }).then(r => r.ok ? r.json() : Promise.reject())
          .then(() => { document.getElementById('admin-chat-text').value=''; loadAdminMessages(); loadAdminThreads(); })
          .catch(() => {});
      });
      loadAdminThreads();
      setInterval(() => { loadAdminThreads(); if (adminActiveUserId) loadAdminMessages(); }, 5000);
    }

    function renderMessages(listEl, rows) {
      if (!listEl) return;
      if (!Array.isArray(rows) || rows.length === 0) {
        listEl.innerHTML = '<div class="note">Aucun message.</div>';
        return;
      }
      const myId = currentUser && currentUser.id;
      listEl.innerHTML = rows.map(m => {
        const mine = myId && m.sender_id === myId;
        const cls = mine ? 'me' : 'them';
        const body = m.body ? String(m.body) : '';
        const d = dateStr(m.created_at);
        return `
          <div class="msg ${cls}">
            <div>
              <div class="bubble">${body}</div>
              <div class="meta">${d}</div>
            </div>
          </div>
        `;
      }).join('');
      listEl.scrollTop = listEl.scrollHeight;
    }

    function loadMemberMessages() {
      fetch(API_BASE + '/messages', { headers: { Authorization: 'Bearer ' + authToken } })
        .then(r => r.ok ? r.json() : [])
        .then(rows => renderMessages(document.getElementById('chat-list'), rows))
        .catch(() => {});
    }

    function loadAdminThreads() {
      fetch(API_BASE + '/admin/messages/threads', { headers: { Authorization: 'Bearer ' + authToken } })
        .then(r => r.ok ? r.json() : [])
        .then(rows => {
          const el = document.getElementById('threads');
          if (!el) return;
          if (!rows || rows.length === 0) { el.innerHTML = '<div class="note">Aucune conversation pour le moment.</div>'; return; }
          el.innerHTML = rows.map(t => {
            const id = t.other_id;
            const name = [t.prenom, t.nom].filter(Boolean).join(' ') || t.email || ('Membre #' + id);
            const last = dateStr(t.last_created);
            const active = adminActiveUserId === id ? 'active' : '';
            return `
              <div class="thread ${active}" data-id="${id}">
                <div class="thread-title">${name}</div>
                <div class="thread-meta">${last}</div>
              </div>
            `;
          }).join('');
          el.querySelectorAll('.thread').forEach(node => {
            node.addEventListener('click', () => {
              adminActiveUserId = parseInt(node.getAttribute('data-id') || '', 10);
              loadAdminThreads();
              loadAdminMessages();
            });
          });
        })
        .catch(() => {});
    }

    function loadAdminMessages() {
      if (!adminActiveUserId) return;
      fetch(API_BASE + '/messages?user_id=' + encodeURIComponent(adminActiveUserId), { headers: { Authorization: 'Bearer ' + authToken } })
        .then(r => r.ok ? r.json() : [])
        .then(rows => {
          renderMessages(document.getElementById('admin-chat-list'), rows);
          // header name refresh happens when thread list reloads
        })
        .catch(() => {});
    }

    function boot() {
      if (!authToken) { renderGate(); return; }
      fetch(API_BASE + '/me', { headers: { Authorization: 'Bearer ' + authToken } })
        .then(r => r.ok ? r.json() : null)
        .then(user => {
          if (!user) { authToken=''; window.localStorage.removeItem('vivelaretraite-token'); renderGate(); return; }
          currentUser = user;
          if (isAdminEmail(user.email)) renderAdminChat();
          else renderMemberChat();
        })
        .catch(() => { renderGate(); });
    }
    boot();
  </script>
</body>
</html>

